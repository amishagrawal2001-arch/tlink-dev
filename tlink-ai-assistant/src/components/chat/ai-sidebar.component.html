        <div class="ai-sidebar-container">
            <!-- Header -->
            <div class="ai-sidebar-header">
                <div class="header-title">
                    <span>AI Assistant</span>
                    <small class="provider-badge" [title]="getProviderDisplayText()">
                        {{ currentProvider }}
                        <span *ngIf="currentModel" class="model-name">‚Ä¢ {{ currentModel }}</span>
                    </small>
                </div>
                <div class="header-actions">
                    <button class="btn btn-link btn-sm btn-close-sidebar" (click)="hideSidebar()" title="Hide Sidebar">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                        </svg>
                    </button>
                    <button class="btn btn-link btn-sm" (click)="switchProvider()" title="Switch Provider">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                        </svg>
                    </button>
                    <button class="btn btn-link btn-sm" (click)="clearChat()" title="Clear Chat">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                    </button>
                    <button class="btn btn-link btn-sm" (click)="exportChat()" title="Export Chat">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Token Usage -->
            <div class="token-usage-bar" *ngIf="currentTokens > 0">
                <div class="usage-progress"
                     [style.width.%]="tokenUsagePercent"
                     [ngClass]="{
                         'usage-low': tokenUsagePercent < 50,
                         'usage-medium': tokenUsagePercent >= 50 && tokenUsagePercent < 80,
                         'usage-high': tokenUsagePercent >= 80
                     }">
                </div>
                <span class="usage-text">{{ currentTokens | number }} / {{ maxTokens | number }} Token</span>
            </div>

            <!-- Messages -->
            <div class="ai-sidebar-messages" #chatContainer (scroll)="onScroll($event)">
                <div *ngFor="let message of messages; let i = index" class="message-item" [ngClass]="message.role">
                    <div class="message-avatar">
                        <svg *ngIf="message.role === 'user'" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                        <svg *ngIf="message.role === 'assistant'" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/>
                            <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/>
                        </svg>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-role">
                                {{ message.role === 'user' ? 'User' : message.role === 'assistant' ? 'AI' : 'System' }}
                            </span>
                            <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
                        </div>

                        <!-- Compatibility: If no uiBlocks, display content -->
                        <ng-container *ngIf="!message.uiBlocks || message.uiBlocks.length === 0">
                            <div class="message-text" [innerHTML]="formatMessage(message.content)"></div>
                        </ng-container>

                        <!-- New data: Iterate through uiBlocks -->
                        <ng-container *ngIf="message.uiBlocks && message.uiBlocks.length > 0">
                            <ng-container *ngFor="let block of message.uiBlocks">

                                <!-- 1. Text block -->
                                <div *ngIf="block.type === 'text'" 
                                     class="message-text" 
                                     [innerHTML]="formatMessage(block.content)">
                                </div>

                                <!-- 2. Tool block -->
                                <div *ngIf="block.type === 'tool'" 
                                     class="tool-call-card"
                                     [ngClass]="{
                                         'tool-executing': block.status === 'executing',
                                         'tool-success': block.status === 'success',
                                         'tool-error': block.status === 'error'
                                     }">
                                    <div class="tool-header">
                                        <span class="tool-icon">
                                            <ng-container [ngSwitch]="block.status">
                                                <ng-container *ngSwitchCase="'executing'">üîß</ng-container>
                                                <ng-container *ngSwitchCase="'success'">‚úÖ</ng-container>
                                                <ng-container *ngSwitchCase="'error'">‚ùå</ng-container>
                                                <ng-container *ngSwitchDefault>üîß</ng-container>
                                            </ng-container>
                                        </span>
                                        <span class="tool-name">{{ block.name || 'Unknown Tool' }}</span>
                                        <span class="tool-status" *ngIf="block.status === 'executing'">Executing...</span>
                                        <span class="tool-duration" *ngIf="block.status !== 'executing' && block.duration">{{ block.duration }}ms</span>
                                    </div>
                                    <!-- Tool output -->
                                    <div *ngIf="block.output && block.output.content" class="tool-output">
                                        <div class="tool-output-header">Output:</div>
                                        <pre class="tool-output-content">{{ block.output.content }}</pre>
                                        <div *ngIf="block.output.truncated" class="tool-output-truncated">...(truncated)</div>
                                    </div>
                                    <!-- Error message -->
                                    <div *ngIf="block.status === 'error' && block.errorMessage" class="tool-output tool-error-message">
                                        <pre class="tool-output-content">{{ block.errorMessage }}</pre>
                                    </div>
                                </div>

                                <!-- 3. Divider block -->
                                <div *ngIf="block.type === 'divider'" class="round-divider">
                                    <span>--- Round {{ block.round }} ---</span>
                                </div>

                                <!-- 4. Status block -->
                                <div *ngIf="block.type === 'status'" class="agent-status">
                                    <span>{{ block.icon }} {{ block.text }}<span *ngIf="block.rounds"> ({{ block.rounds }} rounds)</span></span>
                                </div>

                            </ng-container>
                        </ng-container>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div *ngIf="isLoading" class="message-item assistant loading">
                    <div class="message-avatar">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Z"/>
                        </svg>
                    </div>
                    <div class="message-content">
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scroll buttons -->
            <button *ngIf="showScrollTop" class="scroll-btn scroll-top" (click)="scrollToTop()" title="Scroll to Top">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                </svg>
            </button>
            <button *ngIf="showScrollBottom" class="scroll-btn scroll-bottom" (click)="scrollToBottom()" title="Scroll to Bottom">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L7.293 8 1.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
            </button>

            <!-- Input -->
            <div class="ai-sidebar-input">
                <div class="agent-approval" *ngIf="pendingApproval">
                    <div class="agent-approval-header">
                        <span class="agent-approval-title">{{ pendingApproval.title }}</span>
                        <span class="agent-approval-type">{{ pendingApproval.type | uppercase }}</span>
                    </div>
                    <div class="agent-approval-detail" *ngIf="pendingApproval.detail">
                        {{ pendingApproval.detail }}
                    </div>
                    <pre class="agent-approval-content" *ngIf="pendingApproval.type === 'patch'">{{ pendingApproval.patch }}</pre>
                    <pre class="agent-approval-content" *ngIf="pendingApproval.type === 'command'">{{ pendingApproval.command }}</pre>
                    <div class="agent-approval-actions">
                        <button class="btn btn-sm btn-primary" (click)="approvePending(true)">Approve</button>
                        <button class="btn btn-sm btn-secondary" (click)="approvePending(false)">Reject</button>
                    </div>
                </div>
                <div class="input-container">
                    <textarea
                        #textInput
                        class="message-input"
                        [(ngModel)]="inputValue"
                        [disabled]="isLoading"
                        [placeholder]="isLoading ? 'AI is thinking...' : 'Enter your question or describe the command to execute...'"
                        (keydown)="onKeydown($event)"
                        (input)="onInput($event)"
                        (compositionstart)="isComposing = true"
                        (compositionend)="isComposing = false"
                        rows="1">
                    </textarea>
                    <button
                        class="agent-toggle"
                        [class.active]="forceAgentMode"
                        [disabled]="isLoading"
                        (click)="toggleAgentMode()"
                        title="Toggle Agent Mode">
                        Agent
                    </button>
                    <button
                        class="send-btn"
                        [disabled]="!inputValue.trim() || isLoading"
                        (click)="submit()"
                        title="Send Message">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                        </svg>
                    </button>
                    <button
                        class="cancel-btn"
                        *ngIf="isLoading"
                        (click)="cancelAgentRun()"
                        title="Cancel Agent">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5h5v5h-5z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-footer">
                    <div class="agent-workdir">
                        <label for="agentWorkdir">Work Dir</label>
                        <input
                            id="agentWorkdir"
                            type="text"
                            [value]="workingDir"
                            (input)="updateWorkingDir($event.target.value)"
                            placeholder="/path/to/project" />
                        <button class="btn btn-icon" type="button" (click)="openWorkdirPicker()" title="Browse">
                            <i class="fa fa-folder-open"></i>
                        </button>
                        <input
                            #agentDirInput
                            type="file"
                            webkitdirectory
                            directory
                            (change)="onWorkdirPicked($event)"
                            style="display: none;" />
                        <span class="agent-workdir-warning" *ngIf="!workingDir">
                            Set a Work Dir to enable file saves.
                        </span>
                    </div>
                    <div class="model-switcher" *ngIf="modelOptions.length > 0">
                        <label for="modelSelect">Model</label>
                        <select
                            id="modelSelect"
                            [(ngModel)]="selectedModelProvider"
                            (ngModelChange)="onModelChange($event)">
                            <option *ngFor="let option of modelOptions" [value]="option.name">
                                {{ option.label }}
                            </option>
                        </select>
                    </div>
                    <div class="intent-switcher" *ngIf="intentOptions.length > 0">
                        <label for="intentSelect">Intent</label>
                        <select
                            id="intentSelect"
                            [(ngModel)]="selectedIntent"
                            (ngModelChange)="onIntentChange($event)">
                            <option *ngFor="let intent of intentOptions" [value]="intent.value">
                                {{ intent.label }}
                            </option>
                        </select>
                    </div>
                    <small class="char-count" [ngClass]="{ 'warning': isNearLimit(), 'danger': isOverLimit() }">
                        {{ inputValue.length }} / {{ charLimit }}
                    </small>
                </div>
            </div>
        </div>
